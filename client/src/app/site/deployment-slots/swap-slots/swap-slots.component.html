<div class="wrapper"
    [is-dirty]="swapping || (swapForm && swapForm.dirty)"
    [is-dirty-message]="swapping ? operationInProgressWarning : (swapForm && swapForm.dirty) ? unsavedChangesWarning : null">

    <div class="header">
        <div class="header-icon-container">
            <span class="header-icon" load-image="image/swap.svg"></span>
        </div>

        {{ 'swapSlotsHeading' | translate }}

        <div class="header-close-button"
            role="button"
            title="'close' | translate"
            aria-label="'close' | translate"
            load-image="image/close.svg"
            tabindex="0"
            (click)="closePanel()"
            [activate-with-keys]>
            <span
                class="header-close-button-icon">
            </span>
        </div>
    </div>

    <div class="body" [formGroup]="swapForm" novalidate>
        <div class="body-liner">

            <div class="controls-container">
                <info-box *ngIf="loadingFailure"
                    typeClass="error"
                    [infoText]="loadingFailure">
                </info-box>

                <info-box *ngIf="swapPermissionsMessage"
                    typeClass="warn"
                    [infoText]="swapPermissionsMessage">
                </info-box>

                <info-box *ngIf="writePermissionsMessage"
                    typeClass="warn"
                    [infoText]="writePermissionsMessage">
                </info-box>

                <info-box *ngIf="readOnlyLockMessage"
                    typeClass="warn"
                    [infoText]="readOnlyLockMessage">
                </info-box>
            </div>

            <div class="controls-container">
                <div class="control-container src">
                    <div class="control-label">
                        <div class="bullet src"></div>
                        {{ 'source' | translate }}
                        <div *ngIf="swapForm?.controls['srcId']?.value === siteResourceId" class="pill">{{ 'production' | translate }}</div>
                    </div>
                    <div>
                        <ng-select
                            [loading]="false"
                            [clearable]="false"
                            [items]="srcDropDownOptions"
                            bindLabel="displayLabel"
                            bindValue="value"
                            class="custom-select"
                            formControlName="srcId"
                            (change)="onSlotIdChange()">
                        </ng-select>
                        <div *ngIf="swapForm?.controls['srcId']" class="validation-container">
                            <div *ngIf="!swapForm.pending && swapForm.invalid && swapForm.errors && swapForm.errors['slotsNotUnique']"
                                class="error-message">
                                    {{ swapForm.errors['slotsNotUnique'] }}
                            </div>
                            <ng-container *ngIf="!swapForm.controls['srcId'].pending
                                    && swapForm.controls['srcId'].invalid && swapForm.controls['srcId'].errors">
                                    <div *ngIf="swapForm.controls['srcId'].errors['noSwapPermission']" class="error-message">
                                        {{ swapForm.controls['srcId'].errors['noSwapPermission'] }}
                                    </div>
                                    <div *ngIf="swapForm.controls['srcId'].errors['noWritePermission']" class="error-message">
                                        {{ swapForm.controls['srcId'].errors['noWritePermission'] }}
                                    </div>
                                    <div *ngIf="swapForm.controls['srcId'].errors['readOnlyLock']" class="error-message">
                                        {{ swapForm.controls['srcId'].errors['readOnlyLock'] }}
                                    </div>
                            </ng-container>
                            <div [style.display]="swapForm.controls['srcId'].pending ? 'inherit': 'none'">
                                <span load-image="image/spinner.svg" class="icon-small"></span>
                                <p class="centered-validating-text">{{ 'validating' | translate }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="swap-icon-container">
                    <span
                        class="icon-small"
                        load-image="image/swap.svg">
                    </span>
                </div>

                <div class="control-container dest">
                    <div class="control-label">
                        <div class="bullet dest"></div>
                        {{ 'target' | translate }}
                        <div *ngIf="swapForm?.controls['destId']?.value === siteResourceId" class="pill">{{ 'production' | translate }}</div>
                    </div>
                    <div>
                        <ng-select
                            [loading]="false"
                            [clearable]="false"
                            [items]="destDropDownOptions"
                            bindLabel="displayLabel"
                            bindValue="value"
                            class="custom-select"
                            formControlName="destId"
                            (change)="onSlotIdChange()">
                        </ng-select>
                        <div *ngIf="swapForm?.controls['destId']" class="validation-container">
                            <div *ngIf="!swapForm.pending && swapForm.invalid && swapForm.errors && swapForm.errors['slotsNotUnique']"
                                class="error-message">
                                    {{ swapForm.errors['slotsNotUnique'] }}
                            </div>
                            <ng-container *ngIf="!swapForm.controls['destId'].pending
                                    && swapForm.controls['destId'].invalid && swapForm.controls['destId'].errors">
                                    <div *ngIf="swapForm.controls['destId'].errors['noSwapPermission']" class="error-message">
                                        {{ swapForm.controls['destId'].errors['noSwapPermission'] }}
                                    </div>
                                    <div *ngIf="swapForm.controls['destId'].errors['noWritePermission']" class="error-message">
                                        {{ swapForm.controls['destId'].errors['noWritePermission'] }}
                                    </div>
                                    <div *ngIf="swapForm.controls['destId'].errors['readOnlyLock']" class="error-message">
                                        {{ swapForm.controls['destId'].errors['readOnlyLock'] }}
                                    </div>
                            </ng-container>
                            <div [style.display]="swapForm.controls['destId'].pending ? 'inherit': 'none'">
                                <span load-image="image/spinner.svg" class="icon-small"></span>
                                <p class="centered-validating-text">{{ 'validating' | translate }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls-container">
                <info-box *ngIf="noStickySettings"
                    typeClass="info"
                    [infoText]="'swapMultiPhaseNoStickySettings' | translate">
                </info-box>

                <div class="centered">
                    <label>
                        <input
                            [formControl]="swapForm ? swapForm.controls['multiPhase'] : null"
                            type="checkbox">
                        {{ 'swapWithPreviewLabel' | translate }}
                    </label>
                    <div invalidmessage="form-group" errorkey="authMultiPhaseConflict"></div>
                </div>
            </div>

            <div *ngIf="swapForm?.controls['multiPhase']?.value" class="phase-container">
                <div class="help-text-container">
                    {{ 'swapWithPreviewInfoText' | translate }}
                </div>

                <progress-bar [steps]="phases" class="NavSymbols"></progress-bar>
                <info-box *ngIf="showPreviewLink"
                    typeClass="info"
                    [infoText]="'swapMultiPhasePreviewMessage' | translate"
                    [infoLink]="previewLink">
                </info-box>
            </div>

            <div *ngIf="showPreviewChanges && swapForm?.controls['multiPhase']?.value">

                <h1 class="preview-changes-header">{{ 'phaseOneChangesHeading' | translate }}</h1>
                <div class="help-text-container">
                    {{ 'phaseOneChangesInfoText' | translate }}
                </div>

                <ng-container *ngIf="swapForm?.pending || (swapForm?.valid && loadingDiffs)">
                    {{ 'loading' | translate }}
                </ng-container>

                <ng-container *ngIf="!swapForm?.pending && !swapForm?.valid">
                    {{ 'swapPreviewMakeSelection' | translate }}
                </ng-container>

                <ng-container *ngIf="!swapForm?.pending && swapForm?.valid && !loadingDiffs">

                    <ng-container *ngIf="!stickySettingDiffs">
                        {{ 'swapChangesLoadingFailed' | translate }}
                    </ng-container>

                    <ng-container *ngIf="stickySettingDiffs">

                        <div class="preview-changes-container">
                            <div class="phase-one-preview-indicator">
                                <div class="bullet src"></div>
                                {{ 'swapSourceChangesHeading' | translate }}
                            </div>
                            <tbl tblClass="tbl fixed stretch">
                                <tr class="header-row">
                                    <th class="one-quarter-col padded-col">{{ 'slotsDiff_settingHeader' | translate }}</th>
                                    <th class="one-quarter-col padded-col">{{ 'slotsDiff_typeHeader' | translate }}</th>
                                    <th class="one-quarter-col padded-col">{{ 'slotsDiff_currentValueHeader' | translate }}</th>
                                    <th class="one-quarter-col padded-col">{{ 'slotsDiff_tempValueHeader' | translate }}</th>
                                </tr>

                                <tr *ngFor="let diff of stickySettingDiffs">
                                    <td class="one-quarter-col padded-col">{{ diff.settingName }}</td>
                                    <td class="one-quarter-col padded-col">{{ diff.settingType}}</td>
                                    <td class="one-quarter-col padded-col">{{ diff.valueInCurrentSlot }}</td>
                                    <td class="one-quarter-col padded-col">{{ diff.valueInTargetSlot }}</td>
                                </tr>

                                <tr *ngIf="stickySettingDiffs.length === 0">
                                    <td colspan="4" class="message-row">{{ 'swapDiffsNoChange' | translate }}<td>
                                </tr>
                            </tbl>
                        </div>

                    </ng-container>

                </ng-container>

            </div>

            <div *ngIf="showPreviewChanges">
                <h1 *ngIf="!swapForm?.controls['multiPhase']?.value" class="preview-changes-header">
                    {{ 'swapDiffHeading' | translate }}
                </h1>
                <h1 *ngIf="swapForm?.controls['multiPhase']?.value" class="preview-changes-header">
                    {{ 'phaseTwoChangesHeading' | translate }}
                </h1>
                <div class="help-text-container">
                    {{ 'swapChangesInfoText' | translate }}
                </div>

                <ng-container *ngIf="swapForm?.pending || (swapForm?.valid && loadingDiffs)">
                    {{ 'loading' | translate }}
                </ng-container>


                <ng-container *ngIf="!swapForm?.pending && !swapForm?.valid">
                    {{ 'swapPreviewMakeSelection' | translate }}
                </ng-container>

                <ng-container *ngIf="!swapForm?.pending && swapForm?.valid && !loadingDiffs">

                    <ng-container *ngIf="!slotsDiffs">
                        {{ 'swapChangesLoadingFailed' | translate }}
                    </ng-container>

                    <ng-container *ngIf="slotsDiffs">

                        <div class="preview-changes-container">
                            <div class="preview-toggle-container">
                                <div
                                    class="preview-toggle-button src"
                                    [class.selected]="diffsPreviewSlot==='source'"
                                    [attr.role]="diffsPreviewSlot==='target' ? 'button' : null"
                                    [tabindex]="diffsPreviewSlot==='target' ? 0 : -1"
                                    (click)="diffsPreviewSlot='source'"
                                    [activate-with-keys]>

                                    <div class="bullet src"></div>
                                    {{ 'swapSourceChangesHeading' | translate }}

                                </div>
                                <div
                                    class="preview-toggle-button dest"
                                    [class.selected]="diffsPreviewSlot==='target'"
                                    [attr.role]="diffsPreviewSlot==='source' ? 'button' : null"
                                    [tabindex]="diffsPreviewSlot==='source' ? 0 : -1"
                                    (click)="diffsPreviewSlot='target'"
                                    [activate-with-keys]>

                                    <div class="bullet dest"></div>
                                    {{ 'swapTargetChangesHeading' | translate }}

                                </div>
                            </div>
                        
                            <tbl tblClass="tbl fixed stretch">
                                <tr class="header-row">
                                    <th class="one-quarter-col padded-col">{{ 'slotsDiff_settingHeader' | translate }}</th>
                                    <th class="one-quarter-col padded-col">{{ 'slotsDiff_typeHeader' | translate }}</th>
                                    <th class="one-quarter-col padded-col">{{ 'slotsDiff_oldValueHeader' | translate }}</th>
                                    <th class="one-quarter-col padded-col">{{ 'slotsDiff_newValueHeader' | translate }}</th>
                                </tr>

                                <tr *ngFor="let diff of slotsDiffs">
                                    <td class="one-quarter-col padded-col">{{ diff.settingName }}</td>
                                    <td class="one-quarter-col padded-col">{{ diff.settingType}}</td>
                                    <td class="one-quarter-col padded-col">{{ diffsPreviewSlot==='source' ? diff.valueInCurrentSlot : diff.valueInTargetSlot }}</td>
                                    <td class="one-quarter-col padded-col">{{ diffsPreviewSlot==='source' ? diff.valueInTargetSlot : diff.valueInCurrentSlot }}</td>
                                </tr>

                                <tr *ngIf="slotsDiffs.length === 0" colspan="4">
                                    <td colspan="4" class="message-row">{{ 'swapDiffsNoChange' | translate }}<td>
                                </tr>
                            </tbl>
                        </div>

                    </ng-container>

                </ng-container>
            </div>

            <div *ngIf="showPhase2Controls" class="controls-container">
                <div class="control-container">
                    <div class="control-label">
                        {{ 'swapActionLabel' | translate }}
                    </div>
                    <div>
                        <ng-select
                            [loading]="false"
                            [clearable]="false"
                            [items]="phase2DropDownOptions"
                            bindLabel="displayLabel"
                            bindValue="value"
                            class="custom-select"
                            formControlName="revertSwap">
                        </ng-select>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="footer">

        <div *ngIf="progressMessage"
            class="progress-container">
            <info-box
                [typeClass]="progressMessageClass"
                [infoText]="progressMessage">
            </info-box>
        </div>

        <div class="buttons-container">
            <button *ngIf="!showPhase2Controls"
                class="custom-button"
                (click)="executePhase1()"
                [disabled]="executeButtonDisabed || !swapForm || swapForm.pending || !swapForm.valid">
                {{ (swapForm && swapForm.controls['multiPhase'].value ? 'startSwap' : 'swap') | translate }}
            </button>

            <button *ngIf="showPhase2Controls"
                class="custom-button"
                (click)="executePhase2()"
                [disabled]="executeButtonDisabed || !swapForm || swapForm.pending || !swapForm.valid">
                {{ (swapForm && swapForm.controls['revertSwap'].value ? 'cancelSwap' : 'completeSwap') | translate }}
            </button>

            <button
                class="custom-button"
                (click)="closePanel()">
                {{ 'close' | translate }}
            </button>
        </div>

    </div>

</div>