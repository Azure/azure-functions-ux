{
   "$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "storageAccountName":{
         "type":"string"
      },
      "appName":{
         "type":"string"
      },
      "appLocation":{
         "type":"string"
      },
      "appServicePlanId":{
         "type":"string"
      },
      "sasUrl":{
         "type":"string"
     },
     "aiInstrumentationKey":{
         "type":"string"
     }
   },
   "variables":{
      "location":"[resourceGroup().location]",
      "slotName":"Staging",
      "storageAccountName":"[parameters('storageAccountName')]",
      "storageAccountType":"Standard_LRS",
      "storageAccountid":"[concat(resourceGroup().id,'/providers/','Microsoft.Storage/storageAccounts/', parameters('storageAccountName'))]"
   },
   "resources":[
      {
         "type":"Microsoft.Storage/storageAccounts",
         "name":"[variables('storageAccountName')]",
         "apiVersion":"2015-05-01-preview",
         "location":"[variables('location')]",
         "properties":{
            "accountType":"[variables('storageAccountType')]"
         }
      },
      {
         "apiVersion":"2015-08-01",
         "name":"[parameters('appName')]",
         "type":"Microsoft.Web/sites",
         "location":"[parameters('appLocation')]",
         "properties":{
            "serverFarmId":"[parameters('appServicePlanId')]",
            "siteConfig":{
               "alwaysOn":true,
               "appSettings":[
                  {
                     "name":"FUNCTIONS_SLOT_NAME",
                     "value":"production"
                  },
                  {
                     "name":"WEBSITE_NODE_DEFAULT_VERSION",
                     "value":"4.2.3"
                  },
                  {
                     "name":"ACOM_MARKETING_PAGE",
                     "value":"https://go.microsoft.com/fwlink/?LinkId=761159"
                  },
                  {
                     "name":"WEBSITE_HTTPLOGGING_CONTAINER_URL",
                     "value":"[parameters('sasUrl')]"
                  },
                  {
                     "name":"WEBSITE_WEBDEPLOY_USE_SCM",
                     "value":"true"
                 },
                 {
                     "name":"aiInstrumentationKey",
                     "value":"[parameters('aiInstrumentationKey')]"
                 }
               ],
               "virtualApplications":[
                  {
                     "virtualPath": "/",
                     "physicalPath": "site\\wwwroot",
                     "preloadEnabled": true
                  },
                  {
                     "virtualPath": "/docs",
                     "physicalPath": "site\\docs",
                     "preloadEnabled": true
                  }
                ],
               "cors": {
                   "allowedOrigins": [
                       "https://portal.azure.com",
                       "https://ms.portal.azure.com",
                       "https://onestb.cloudapp.net:8443",
                       "https://web1.appsvcux.ext.azure.com",
                       "https://webcanary.appsvcux.ext.azure.com"
                   ]
               }
            }
            //"hostNames":[
               //"functions.trafficmanager.net",
               //"functions.azure.com",
               //"[concat(parameters('appName'), '.azurewebsites.net')]"
            //],
            //"hostNameSslStates":[
               //{
                  //"name":"functions.azure.com",
                  //"sslState":1,
                  //"thumbprint":"24FF1B66125A680A292AC71EDD4230F14A6174A4",
                  //"toUpdate":true
               //}
            //]
         },
         "resources":[
            {
               "apiVersion":"2015-08-01",
               "name":"slotconfignames",
               "type":"config",
               "dependsOn":[
                  "[resourceId('Microsoft.Web/Sites', parameters('appName'))]"
               ],
               "properties":{
                  "appSettingNames":[
                     "FUNCTIONS_SLOT_NAME",
                     "ACOM_MARKETING_PAGE"
                  ]
               }
            },
            {
               "apiVersion":"2015-08-01",
               "name":"[variables('slotName')]",
               "type":"slots",
               "location":"[parameters('appLocation')]",
               "dependsOn":[
                  "[resourceId('Microsoft.Web/Sites', parameters('appName'))]"
               ],
               "properties":{
                  "siteConfig":{
                    "appSettings":[
                        {
                           "name":"FUNCTIONS_SLOT_NAME",
                           "value":"staging"
                        },
                        {
                           "name":"WEBSITE_NODE_DEFAULT_VERSION",
                           "value":"4.2.3"
                        },
                        {
                           "name":"ACOM_MARKETING_PAGE",
                           "value":"http://go.microsoft.com/fwlink/?LinkId=780685"
                        },
                        {
                           "name":"WEBSITE_HTTPLOGGING_CONTAINER_URL",
                           "value":"[parameters('sasUrl')]"
                        },
                        {
                           "name":"WEBSITE_WEBDEPLOY_USE_SCM",
                           "value":"true"
                        },
                        {
                            "name":"aiInstrumentationKey",
                            "value":"[parameters('aiInstrumentationKey')]"
                        }
                    ],
                    "virtualApplications":[
                        {
                           "virtualPath": "/",
                           "physicalPath": "site\\wwwroot",
                           "preloadEnabled": true
                        },
                        {
                           "virtualPath": "/docs",
                           "physicalPath": "site\\docs",
                           "preloadEnabled": true
                        }
                    ]
                  }
               },
               "resources":[
                  {
                     "apiVersion":"2015-08-01",
                     "name":"web",
                     "type":"sourcecontrols",
                     "dependsOn":[
                        "[resourceId('Microsoft.Web/Sites/slots', parameters('appName'), variables('slotName'))]"
                     ],
                     "properties":{
                        "RepoUrl":"https://github.com/projectkudu/AzureFunctions",
                        "branch":"master"
                     }
                  }
               ]
            }
         ]
      }
   ]
}
